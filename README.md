# VersionedStorage
Библиотека управления версионным хранением записей

Назначение библиотеки
---------------------
Предлагаемая библиотека позволяет реализовать прозрачное хранение истории изменения записей в источнике данных.

Один из возможных сценариев использования библиотеки - создание, изменение и удаление записей в реляционной базе данных, поддерживающей SQL, с сохранением истории изменений записей при выполнении операторов UPDATE и DELETE.

В состав библиотеки входят классы, составляющие каркас, на основе которого возможно реализовать управление версионным хранением записей вообще в любом источнике данных, не ограничиваясь поддержкой SQL.

Представление истории изменения записей
---------------------------------------------------
Для обеспечения хранения полной истории изменения и удаления записей в хранилище данных, в этой библиотеке принята следующая концепция:

* Информация в источнике данных хранится в виде набора записей с полями
* Каждая запись однозначно идентифицируется сквозным уникальным номером версии
* При добавлении записи:
  - запись получает свой собственный уникальный идентификатор версии
* При изменении полей записи:
  - предыдущая версия записи помечается как неактуальная, без изменения полей
  - создается новая запись с новым номером версии, обновленными значениями полей и со ссылкой на предыдущую версию записи
* При удалении записи:
  - запись помечается как удаленная, фактическое удаление данных из хранилища не производится.

Для хранения системной информации по истории изменений записей, в каждую запись добавляются следующие поля:
* RECORD_ID   (int)        - уникальный идентификатор версии записи
* IS_ACTUAL   (bool)       - признак актуальности версии записи
* PREV_RECORD_ID (int?)    - идентификатор предыдущей версии записи; если это первая версия записи, то null
* CREATED_BY (string)      - идентификатор пользователя, от имени которого создана текущая версия записи
* CREATED_DATE (DateTime)  - дата создания версии записи
* DELETED_BY (string)      - идентификатор пользователя, от имени которого произведено удаление записи; если запись не была удалена, то null
* DELETED_DATE (DateTime?) - дата удаления запси; если запись не была удалена, то null

Если для хранения записей используется база данных, то указанные поля с соответствующим типом данных должны быть созданы в таблицах.

Примеры использования библиотеки
---------------------

```
//создание объекта управления версионным хранением данных в БД
//изменения будут производиться в транзакции transaction, автором изменений будет "testUser"
SqlVersionedStorage versionedStorage = new SqlVersionedStorage(transaction, "testUser");
```
```
//добавление новой записи
int recordId = versionedStorage.Insert(
	"SAMPLE_TABLE",
	new Dictionary<string, object>()
	{
		{ "INVOICE_NO", "2017-0001" },
		{ "SUPPLIER", "ACME LLC." },
		{ "PRICE", 1200 },
		{ "WEIGHT", 850 }
	});
```
```
//внесение изменений в существующую запись
int secondRecordVersionId = versionedStorage.Update(
	"SAMPLE_TABLE",
	recordId,
	new Dictionary<string, object>()
	{
		{ "INVOICE_NO", "2017-0001" },
		{ "SUPPLIER", "ACME LTD." },
		{ "PRICE", 1200000 },
		{ "WEIGHT", 850 }
	});
```
```
//удаление записи
//с сохранением истории изменений
versionedStorage.Delete("SAMPLE_TABLE", secondRecordVersionId);
```

# Описание классов

GenericVersionedStorage
-----------------------
Реализует общий интерфейс управления версионным хранением записей IVersionedStorage.

Обеспечивает создание, изменение и удаление записей в хранилище данных с сохранением истории изменений. 

Имеет методы Insert(), Update(), Delete(). 

Для реализации стратегии работы с конкретным источником данных, использует вспомогательные классы, реализующие интерфейсы IQueryGenerator и IQueryExecutor.

SqlVersionedStorage
-------------------
Является производным от GenericVersionedStorage. 

Реализует интерфейс управления версионным хранением записей в источниках данных, поддерживающим транзакции и синтаксис SQL.

Для реализации стратегий генерации и исполнения запросов использует экземпляры SqlQueryGenerator и SqlQueryExecutor.

SqlQueryGenerator
-----------------
Реализует интерфейс IQueryGenerator. 

Обеспечивает генерацию параметризованных запросов для операций Select, Insert, Update, Delete для СУБД, поддерживающих стандарт SQL.

Если потребуется реализовать поддержку нового провайдера данных, синтаксис запросов и параметров у которого отличается от общепринятого SQL, следует создать производный класс и переопределить требуемые методы.

SqlQueryExecutor
----------------
Реализует интерфейс IQueryExecutor. 

Обеспечивает выполнение параметризованных запросов для источников данных, поддерживающих транзакции и язык SQL.

Если потребуется реализовать поддержку нового провайдера данных, у которого модель доступа к данным отличается от классической архитектуры DbCommand->DataAdapter->DataReader, следует создать производный класс и переопределить требуемые методы.

ParametrizedQuery
-----------------
Реализует интерфейс IParametrizedQuery.

Представляет параметризованный запрос к источнику данных, состоящий из текста запроса и набора параметров.
